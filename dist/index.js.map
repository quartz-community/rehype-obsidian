{"version":3,"sources":["../src/lib/block-references.ts","../src/lib/checkbox.ts","../src/lib/mermaid-expand.ts","../src/lib/youtube-embed.ts","../src/index.ts"],"sourcesContent":["import type { Element, Parent, Root, Text } from \"hast\";\nimport { visit } from \"unist-util-visit\";\n\nconst blockReferenceRegex = /\\^([-_A-Za-z0-9]+)$/;\nconst inlineTagTypes = new Set([\"p\", \"li\"]);\nconst blockTagTypes = new Set([\"blockquote\"]);\n\ntype VFileData = {\n  blocks: Record<string, Element>;\n  htmlAst?: Root;\n} & Record<string, unknown>;\n\ntype VFileLike = { data?: Record<string, unknown> };\n\nconst isElement = (node: unknown): node is Element =>\n  typeof node === \"object\" &&\n  node !== null &&\n  (node as Element).type === \"element\";\n\nconst isText = (node: unknown): node is Text =>\n  typeof node === \"object\" && node !== null && (node as Text).type === \"text\";\n\nconst isParent = (node: unknown): node is Parent =>\n  typeof node === \"object\" &&\n  node !== null &&\n  Array.isArray((node as Parent).children);\n\nconst ensureFileData = (file: VFileLike): VFileData => {\n  if (!file.data) {\n    file.data = {};\n  }\n\n  const data = file.data as VFileData;\n  if (!data.blocks) {\n    data.blocks = {};\n  }\n\n  return data;\n};\n\nconst applyBlockId = (\n  node: Element,\n  blockId: string,\n  blocks: Record<string, Element>,\n) => {\n  if (!node.properties) {\n    node.properties = {};\n  }\n  node.properties.id = blockId;\n  blocks[blockId] = node;\n};\n\nexport const blockReferences = (tree: Root, file: VFileLike) => {\n  const data = ensureFileData(file);\n  const blocks = data.blocks;\n\n  visit(\n    tree,\n    \"element\",\n    (node: Element, index: number | undefined, parent: Parent | undefined) => {\n      if (!isElement(node)) return;\n\n      if (blockTagTypes.has(node.tagName)) {\n        if (!isParent(parent) || typeof index !== \"number\") return;\n        const siblingIndex = index + 2;\n        const sibling = parent.children[siblingIndex];\n        if (!isElement(sibling) || sibling.tagName !== \"p\") return;\n\n        const firstChild = sibling.children[0];\n        if (!isText(firstChild)) return;\n\n        const match = firstChild.value.match(blockReferenceRegex);\n        if (!match) return;\n\n        const blockId = match[1];\n        parent.children.splice(siblingIndex, 1);\n        applyBlockId(node, blockId, blocks);\n        return;\n      }\n\n      if (!inlineTagTypes.has(node.tagName)) return;\n\n      const children = node.children;\n      if (!children || children.length === 0) return;\n\n      const lastChild = children[children.length - 1];\n      if (!isText(lastChild)) return;\n\n      const match = lastChild.value.match(blockReferenceRegex);\n      if (!match) return;\n\n      const blockId = match[1];\n      const stripped = lastChild.value\n        .replace(blockReferenceRegex, \"\")\n        .trimEnd();\n\n      if (stripped.length === 0) {\n        children.pop();\n\n        if (isParent(parent)) {\n          for (let i = (index ?? 0) - 1; i >= 0; i -= 1) {\n            const sibling = parent.children[i];\n            if (isElement(sibling)) {\n              applyBlockId(sibling, blockId, blocks);\n              return;\n            }\n          }\n        }\n\n        applyBlockId(node, blockId, blocks);\n        return;\n      }\n\n      lastChild.value = stripped;\n      applyBlockId(node, blockId, blocks);\n    },\n  );\n\n  data.htmlAst = tree;\n};\n","import type { Element, Root } from \"hast\";\nimport { visit } from \"unist-util-visit\";\n\nconst isElement = (node: unknown): node is Element =>\n  typeof node === \"object\" &&\n  node !== null &&\n  (node as Element).type === \"element\";\n\nexport const checkbox = (tree: Root) => {\n  visit(tree, \"element\", (node: Element) => {\n    if (!isElement(node) || node.tagName !== \"input\") return;\n    if (!node.properties || node.properties.type !== \"checkbox\") return;\n\n    const properties = node.properties;\n    const checked = properties.checked;\n\n    node.properties = {\n      ...properties,\n      checked,\n      disabled: false,\n      className: \"checkbox-toggle\",\n    };\n  });\n};\n","import type { Element, Parent, Root } from \"hast\";\nimport { visit } from \"unist-util-visit\";\n\nconst isElement = (node: unknown): node is Element =>\n  typeof node === \"object\" &&\n  node !== null &&\n  (node as Element).type === \"element\";\n\nconst isParent = (node: unknown): node is Parent =>\n  typeof node === \"object\" &&\n  node !== null &&\n  Array.isArray((node as Parent).children);\n\nconst hasClassName = (node: Element, className: string) => {\n  const classes = node.properties?.className;\n  if (Array.isArray(classes)) {\n    return classes.includes(className);\n  }\n  if (typeof classes === \"string\") {\n    return classes.split(/\\s+/).includes(className);\n  }\n  return false;\n};\n\nconst expandButton = (): Element => ({\n  type: \"element\",\n  tagName: \"button\",\n  properties: {\n    className: [\"expand-button\"],\n    \"aria-label\": \"Expand mermaid diagram\",\n    \"data-view-component\": true,\n  },\n  children: [\n    {\n      type: \"element\",\n      tagName: \"svg\",\n      properties: {\n        width: 16,\n        height: 16,\n        viewBox: \"0 0 16 16\",\n        fill: \"currentColor\",\n      },\n      children: [\n        {\n          type: \"element\",\n          tagName: \"path\",\n          properties: {\n            d: \"M3.72 3.72a.75.75 0 011.06 1.06L2.56 7h10.88l-2.22-2.22a.75.75 0 011.06-1.06l3.5 3.5a.75.75 0 010 1.06l-3.5 3.5a.75.75 0 11-1.06-1.06l2.22-2.22H2.56l2.22 2.22a.75.75 0 11-1.06 1.06l-3.5-3.5a.75.75 0 010-1.06l3.5-3.5z\",\n          },\n          children: [],\n        },\n      ],\n    },\n  ],\n});\n\nconst mermaidContainer = (): Element => ({\n  type: \"element\",\n  tagName: \"div\",\n  properties: { id: \"mermaid-container\", role: \"dialog\" },\n  children: [\n    {\n      type: \"element\",\n      tagName: \"div\",\n      properties: { id: \"mermaid-space\" },\n      children: [\n        {\n          type: \"element\",\n          tagName: \"div\",\n          properties: { className: [\"mermaid-content\"] },\n          children: [],\n        },\n      ],\n    },\n  ],\n});\n\nexport const mermaidExpand = (tree: Root) => {\n  visit(\n    tree,\n    \"element\",\n    (node: Element, _index: number | undefined, parent: Parent | undefined) => {\n      if (!isElement(node) || node.tagName !== \"code\") return;\n      if (!hasClassName(node, \"mermaid\")) return;\n      if (!isParent(parent)) return;\n\n      parent.children = [expandButton(), node, mermaidContainer()];\n    },\n  );\n};\n","import type { Element, Parent, Root } from \"hast\";\nimport { visit } from \"unist-util-visit\";\n\nconst youTubeVideoRegex =\n  /^.*(youtu.be\\/|v\\/|u\\/\\w\\/|embed\\/|watch\\?v=|\\&v=)([^#\\&\\?]*).*/;\nconst youTubePlaylistRegex = /[?&]list=([^#?&]*)/;\n\nconst isElement = (node: unknown): node is Element =>\n  typeof node === \"object\" &&\n  node !== null &&\n  (node as Element).type === \"element\";\n\nconst isParent = (node: unknown): node is Parent =>\n  typeof node === \"object\" &&\n  node !== null &&\n  Array.isArray((node as Parent).children);\n\nexport const youTubeEmbed = (tree: Root) => {\n  visit(\n    tree,\n    \"element\",\n    (node: Element, index: number | undefined, parent: Parent | undefined) => {\n      if (!isElement(node) || node.tagName !== \"img\") return;\n      if (!node.properties) return;\n\n      const src = node.properties.src;\n      if (typeof src !== \"string\") return;\n\n      const videoMatch = src.match(youTubeVideoRegex);\n      const playlistMatch = src.match(youTubePlaylistRegex);\n      const playlistId = playlistMatch?.[1];\n      const videoId = videoMatch?.[2];\n\n      const validVideoId =\n        videoId && videoId.length === 11 ? videoId : undefined;\n      if (!validVideoId && !playlistId) return;\n\n      let iframeSrc: string;\n      if (validVideoId && playlistId) {\n        iframeSrc = `https://www.youtube.com/embed/${validVideoId}?list=${playlistId}`;\n      } else if (validVideoId) {\n        iframeSrc = `https://www.youtube.com/embed/${validVideoId}`;\n      } else {\n        iframeSrc = `https://www.youtube.com/embed/videoseries?list=${playlistId}`;\n      }\n\n      const iframe: Element = {\n        type: \"element\",\n        tagName: \"iframe\",\n        properties: {\n          className: [\"external-embed\", \"youtube\"],\n          allow: \"fullscreen\",\n          frameBorder: 0,\n          width: \"600px\",\n          src: iframeSrc,\n        },\n        children: [],\n      };\n\n      if (!isParent(parent) || typeof index !== \"number\") return;\n      parent.children[index] = iframe;\n    },\n  );\n};\n","import type { Root } from \"hast\";\n\nimport { blockReferences } from \"./lib/block-references.js\";\nimport { checkbox } from \"./lib/checkbox.js\";\nimport { mermaidExpand } from \"./lib/mermaid-expand.js\";\nimport { youTubeEmbed } from \"./lib/youtube-embed.js\";\n\nexport interface RehypeObsidianOptions {\n  blockReferences?: boolean;\n  youTubeEmbed?: boolean;\n  checkbox?: boolean;\n  mermaid?: boolean;\n}\n\nconst defaultOptions: Required<RehypeObsidianOptions> = {\n  blockReferences: true,\n  youTubeEmbed: true,\n  checkbox: true,\n  mermaid: true,\n};\n\nexport default function rehypeObsidian(userOpts?: RehypeObsidianOptions) {\n  const opts = { ...defaultOptions, ...userOpts };\n  return (tree: Root, file: { data?: Record<string, unknown> }) => {\n    if (opts.blockReferences) blockReferences(tree, file);\n    if (opts.youTubeEmbed) youTubeEmbed(tree);\n    if (opts.checkbox) checkbox(tree);\n    if (opts.mermaid) mermaidExpand(tree);\n  };\n}\n\nexport { blockReferences, youTubeEmbed, checkbox, mermaidExpand };\n"],"mappings":"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","names":["match","blockId","visit","isElement","visit","isElement","isParent","visit","isElement","isParent"]}